<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>動画からWAV変換ツール</title>
  </head>
  <body>
    <h1>動画からWAVに変換</h1>
    <p>ここにMOVまたはMP4ファイルをアップロードしてください:</p>
    <input type="file" id="fileInput" accept=".mov, .mp4" />
    <button id="convertButton" disabled>変換する</button>
    <p id="status">状態: ファイルを選択してください。</p>
    <a id="downloadLink" style="display: none">変換されたWAVをダウンロード</a>

    <script>
      // モジュール読み込み
      const loadFFmpeg = async () => {
        try {
          // 正しいURLを使ってFFmpegを読み込む
          const ffmpegModule = await import(
            "https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.8.3/dist/ffmpeg.min.js"
          );
          return ffmpegModule;
        } catch (error) {
          console.error("FFmpegモジュールの読み込みに失敗しました:", error);
          alert(
            "FFmpegの読み込みに失敗しました。インターネット接続を確認し、再試行してください。"
          );
          throw error; // エラーを再投げする
        }
      };

      const fileInput = document.getElementById("fileInput");
      const convertButton = document.getElementById("convertButton");
      const statusText = document.getElementById("status");
      const downloadLink = document.getElementById("downloadLink");

      let ffmpeg;
      let selectedFile;

      const initializeFFmpeg = async () => {
        const ffmpegModule = await loadFFmpeg();

        // モジュールが正しくロードされたか確認
        if (ffmpegModule && ffmpegModule.createFFmpeg) {
          ffmpeg = ffmpegModule.createFFmpeg({ log: true });
          await ffmpeg.load(); // FFmpegの読み込みが完了するまで待機
        } else {
          throw new Error("FFmpegモジュールの読み込みに失敗しました");
        }
      };

      fileInput.addEventListener("change", (event) => {
        selectedFile = event.target.files[0];
        if (selectedFile) {
          statusText.textContent = `状態: ${selectedFile.name} が選択されました。`;
          convertButton.disabled = false;
        } else {
          statusText.textContent = "状態: ファイルを選択してください。";
          convertButton.disabled = true;
        }
      });

      convertButton.addEventListener("click", async () => {
        try {
          if (!ffmpeg) {
            // FFmpegが初期化されていない場合、初期化を実行
            statusText.textContent = "状態: FFmpegを初期化しています...";
            await initializeFFmpeg();
          }

          statusText.textContent = "状態: 変換中...";

          const fileName = selectedFile.name;
          const inputFileName = `input_${fileName}`;
          const outputFileName = `output.wav`;

          // ファイルをFFmpeg仮想ファイルシステムに読み込み
          ffmpeg.FS("writeFile", inputFileName, await fetchFile(selectedFile));

          // 動画をWAVに変換
          await ffmpeg.run(
            "-i",
            inputFileName,
            "-vn",
            "-acodec",
            "pcm_s16le",
            "-ar",
            "44100",
            outputFileName
          );

          // 結果を取得
          const data = ffmpeg.FS("readFile", outputFileName);

          // Blobを作成し、ダウンロードリンクを更新
          const blob = new Blob([data.buffer], { type: "audio/wav" });
          const url = URL.createObjectURL(blob);

          downloadLink.href = url;
          downloadLink.download = `${fileName.split(".")[0]}.wav`;
          downloadLink.style.display = "inline";
          downloadLink.textContent = "変換されたWAVをダウンロード";
          statusText.textContent = "状態: 変換が完了しました！";
        } catch (error) {
          console.error(error);
          statusText.textContent = `エラー: ${error.message}`;
        }
      });
    </script>
  </body>
</html>
